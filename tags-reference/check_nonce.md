# check_nonce

A *nonce* is a random or semi-random value that is generated for a specific use[^1].

[^1]: https://www.techtarget.com/searchsecurity/definition/nonce

The self-closing tag **check_nonce** comes with Data-bound Forms and is part of the nonce-related tags trio. Tag helps verify that *action* is indeed requested by the original claimant.

```xml
<cms:check_nonce action='delete_page_151' nonce='6bbad4aac63c44f7b510c158ad931413' />
```

Return value is either ***1*** or ***0*** (if nonce does not match action)

## Parameters

* **action**
* **nonce** (semi-optional)

  The **action** is mandatory and is a simple string. The **nonce** can be omitted, but only if the request (GET, POST, etc) has *nonce* passed in it e.g. as a query string parameter in URL.

## Example

In following example the nonce is passed via query string –

> `?act=delete&page=151&nonce=6bbad4aac63c44f7b510c158ad931413`

– and page recieving the request has following code –

```xml
<!-- read 'act' from query string -->
<cms:set act="<cms:gpc 'act' method='get' />" />

<cms:if act eq 'delete'>

    <!-- create action string using 'page' from query string -->
    <cms:set myAction="delete_page_<cms:gpc 'page' />" />

    <!-- verify nonce and save result to variable -->
    <cms:set canDelete="<cms:check_nonce action=myAction />" />

    <cms:if canDelete>
      <!-- proceed to delete page OK -->
      ..

    <cms:else/>
      <!-- nonce check failed; proceed with due care -->

      <!-- log requested action to log.txt -->
      <cms:log "Unauthorized attempt with — <cms:show myAction />" />

      <!-- log ip-address of the kid then abort to 'not-found' page -->
      <cms:abort is_404='1' />
    </cms:if>
</cms:if>
```

**NOTE:** There is a striking difference between tag **check_nonce** and its sibling tag **validate_nonce** — the former (check) has a return value (***1*** or ***0***) and allows the administrator to do something in case verification fails. Exactly this scenario is illustrated in the above code listing.

## Databound forms

Every databound form i.e. created with tag &lt;cms:form masterpage='' ..&gt; already has a nonce supplied via automatically added hidden input e.g. –

```html
<input type="hidden" id="nonce" name="nonce" value="9005490d35955b2b0ef4f8f2df16dbbc">
```

In Admin Panel you can see such input in the source of each list-view. There it is used for deleting pages and if the nonce is not correct, then there will appear a message from CMS:

> **Security tokens do not tally for executing this action. Please try again.**

Nonces are already built-in for many links generated by the CMS e.g. logout link, page-edit link etc. Trying to access the edit-view of a page using wrong nonce leads to message

> **Page not found**

## Code insight — nonce

*section is intentionally repeated in all three nonce-tags for reference*

Three things go into creating a nonce –

  - Current user,
  - the action this nonce is created for, and
  - a time period for which the nonce remains valid

*Current user* is the authorized user's login name or, in case of anonymous users, it's the PHP session's ID.

*Action* is any string designated by the programmer to be the handler for the nonce

*Time period* is the limited time frame, usually within 12-24 hrs, during which the nonce is still valid.

The three parts above consist of a *message*, that is hashed alongside a *secret key* — a key called *nonce_secret_key* stored in database table `couch_settings`. The secret key is a unique 64-length string, automatically generated upon each CouchCMS installation i.e. unique per each website.

Resulting hash of the *message* and *nonce_secret_key* becomes the ***salt*** for the second iteration of message hashing. Both hashes use **hash_hmac (md5)** PHP function. Resulting hash is the actual nonce that we can see. This operation is performed for passed **action** by each of the three nonce-related tags in order to compare the newly-generated nonce with the nonce coming from the outside.

The executive summary is that nonces are arbitrary short-lived values that cannot be predicted by the attacker.

## Variables

Sets no variables of its own.

## Related Tags

* [**create_nonce**](https://github.com/trendoman/Midware/tree/main/tags-reference/create_nonce.md)
* [**check_nonce**](https://github.com/trendoman/Midware/tree/main/tags-reference/check_nonce.md) — has return value ***1*** or ***0***
* [**validate_nonce**](https://github.com/trendoman/Midware/tree/main/tags-reference/validate_nonce.md) — aborts the page for invalid nonces

## Related pages

* **[CouchCMS forum topic » Deleting page from the front-end](https://www.couchcms.com/forum/viewtopic.php?f=4&t=8087#p13980)** — a good example on databound forms with nonces
* **[PHP.net Manuals » hash_hmac](https://www.php.net/manual/en/function.hash-hmac)**
