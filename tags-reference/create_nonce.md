# create_nonce

A *nonce* is a random or semi-random value that is generated for a specific use[^1].

[^1]: https://www.techtarget.com/searchsecurity/definition/nonce

The self-closing tag **create_nonce** comes with Data-bound Forms and is part of the nonce-related tags trio. Tag helps create a nonce for any *action*.

```xml
<cms:create_nonce action='delete_page_151' />
```

Result (sample):

> 9a4271d9b88110d056604fe4d8a6d1fb

Return value is a 32-length hash produced via a series of calculations (see below).

## Parameters

* **action**

  The **action** is mandatory and is a simple string.

## Example

It is quite easy to spot this tag In CouchCMS Admin Panel – find the following line in `couch/theme/_system/content_list.html`

```html
<input type="hidden" id="nonce" name="nonce" value="<cms:create_nonce 'bulk_action_page' />">
```

Unlike the static action 'bulk_action_page' we can have any programmatically generated value —

```xml
<cms:create_nonce "<cms:concat 'delete_page_' k_page_id />" />
<!-- using 'k_page_id' to craft a dynamic action -->
```

If not in a form with input, add a nonce to a *myLink* being designed via **add_querystring** tag —

```xml
<cms:set cartAct = "confirm_purchase" />
<cms:set nonceQS = "nonce=<cms:create_nonce cartAct />" />
<cms:set myLink = "<cms:add_querystring link=myLink querystring=nonceQS />"/>
<!-- then sends myLink to buyer via email -->
```

Helpful for confirmations within a 12-24 hour period, nonces are very secure way of making sure the visitor is indeed the one who made the purchase (for above example). Please see the [code insight](#code-insight--nonce) section that zooms-in on this point.

## Databound forms

Every databound form i.e. created with tag &lt;cms:form masterpage='' ..&gt; already has a nonce supplied via automatically added hidden input e.g. –

```html
<input type="hidden" id="nonce" name="nonce" value="9005490d35955b2b0ef4f8f2df16dbbc">
```

In Admin Panel you can see such input in the source of each list-view. There it is used for deleting pages and if the nonce is not correct, then there will appear a message from CMS:

> **Security tokens do not tally for executing this action. Please try again.**

Nonces are already built-in for many links generated by the CMS e.g. logout link, page-edit link etc. Trying to access the edit-view of a page using wrong nonce leads to message

> **Page not found**

## Code insight — nonce

Three things go into creating a nonce –

  - Current user,
  - the action this nonce is created for, and
  - a time period for which the nonce remains valid

*Current user* is the authorized user's login name or, in case of anonymous users, it's the PHP session's ID.

*Action* is any string designated by the programmer to be the handler for the nonce

*Time period* is the limited time frame, usually within 12-24 hrs, during which the nonce is still valid.

The three parts above consist of a *message*, that is hashed alongside a *secret key* — a key called *nonce_secret_key* stored in database table `couch_settings`. The secret key is a unique 64-length string, automatically generated upon each CouchCMS installation i.e. unique per each website.

Resulting hash of the *message* and *nonce_secret_key* becomes the ***salt*** for the second iteration of message hashing. Both hashes use **hash_hmac (md5)** PHP function. Resulting hash is the actual nonce that we can see. This operation is performed for passed **action** by each of the three nonce-related tags in order to compare the newly-generated nonce with the nonce coming from the outside.

The executive summary is that nonces are arbitrary short-lived values that cannot be predicted by the attacker.

## Variables

Sets no variables of its own.

## Related Tags

* [**create_nonce**](https://github.com/trendoman/Midware/tree/main/tags-reference/create_nonce.md)
* [**check_nonce**](https://github.com/trendoman/Midware/tree/main/tags-reference/check_nonce.md) — has return value ***1*** or ***0***
* [**validate_nonce**](https://github.com/trendoman/Midware/tree/main/tags-reference/validate_nonce.md) — aborts the page for invalid nonces

## Related pages

* **[CouchCMS forum topic » Deleting page from the front-end](https://www.couchcms.com/forum/viewtopic.php?f=4&t=8087#p13980)** — a good example on databound forms with nonces
* **[PHP.net Manuals » hash_hmac](https://www.php.net/manual/en/function.hash-hmac)**
* **[Tweakus » Gallery drag & drop](https://github.com/trendoman/Tweakus-Dilectus/tree/main/anton.cms%40ya.ru__admin-panel-tweaks/gallery-drag-drop)** — example of creating a nonce to make ajax-powered PHP action in Admin Panel
